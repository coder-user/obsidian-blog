# API 网关：系统的门面要如何做呢？

## API 网关起到的作用（904）

**API 网关**（API Gateway）不是一个开源组件，而是一种架构模式，它是将一些服务共有的功能整合在一起，独立部署为单独的一层，用来解决一些**服务治理**的问题。你可以把它看作系统的边界，它可以对出入系统的流量做统一的管控。

> [!tip] 网关可以分为两类：
>
> 1. 入口网关
> 2. 出口网关

## 入口网关

入口网关是我们经常使用的网关种类，入目前开发的 YBFE 它**部署在负载均衡服务器（LB）和应用服务器（业务服务器）之间**，主要有几方面的作用。

1. 提供客户端一个**统一的接入地址**，API 网关可以将用户的请求**动态路由**到不同的业务服务上，并且做一些必要的**协议转换**工作。
2. 可以植入一些**服务治理**的策略，比如服务的**熔断、降级，流量控制和分流**等等
3. 客户端的认证和授权的实现，也可以放在 API 网关中
4. 可以做一些与黑白名单相关的事情，比如针对设备 ID、用户 IP、用户 ID 等维度的黑白名单。（安全相关处理）
5. 可以做一些日志记录的事情，比如记录 HTTP 请求的访问日志，分布式追踪系统时，提到的标记一次请求的 requestId，也可以在网关中来生成。

![](27%20API网关：系统的门面要如何做呢？_image_1.png)

## 出口网关

**应用服务器和第三方系统**之间，部署出口网关，在出口网关中，对调用外部的 API 做统一的认证、授权，审计以及访问控制。
![](27%20API网关：系统的门面要如何做呢？_image_2.png)

## API 网关要如何实现

1. 首先要考虑的是它的性能，提升 API 网关性能的关键还是在 I/O 模型上。
2. API 网关的设计要**注意扩展性**，也就是你可以随时在网关的执行链路上，增加一些逻辑，也可以随时下掉一些逻辑（也就是所谓的热插拔）
3. 一般来说，我们可以把每一个操作定义为一个 filter（过滤器），然后使用“**责任链模式**”将这些 filter 串起来。责任链可以动态地组织这些 filter，解耦 filter 之间的关系，无论是增加还是减少 filter，都不会对其他的 filter 有任何的影响。

> [!tip] Zuul 的实现

**Zuul** 就是采用**责任链模式**，Zuul1 中将 filter 定义为三类：pre routing filter（路由前过滤器）、routing filter（路由过滤器）和 after routing filter（路由后过滤器）
![](27%20API网关：系统的门面要如何做呢？_image_3.png)

## 一些开源的 API 网关

1. Kong 是在 Nginx 中运行的 Lua 程序。
2. Zuul 是 Spring Cloud 全家桶中的成员，如果你已经使用了 Spring Cloud 中的其他组件，那么也可以考虑使用 Zuul 和它们无缝集成。
3. Tyk 是一种 Go 语言实现的轻量级 API 网关，有着丰富的插件资源，对于 Go 语言栈的团队来说，也是一种不错的选择。

## 如何在你的系统中引入 API 网关呢？

**针对服务接口数据聚合的操作**，一般有两种解决思路：

1. 再独立出一组网关专门做服务聚合、超时控制方面的事情，我们一般把前一种网关叫做流量网关，后一种可以叫做业务网关；
2. 抽取独立的服务层，专门做接口聚合的操作。这样服务层就大概分为原子服务层和聚合服务层。

接口数据聚合是业务操作，与其放在通用的网关层来实现，不如放在更贴近业务的服务层来实现，所以，更倾向于第二种方案。
![](27%20API网关：系统的门面要如何做呢？_image_4.png)

## 小结

API 网关引入你的系统，我想强调的重点如下：

1. API 网关分为入口网关和出口网关两类，**入口网关**作用很多，可以隔离客户端和微服务，从中提供**协议转换、安全策略、认证、限流、熔断**等功能。出口网关主要是为调用第三方服务提供统一的出口，在其中可以对调用外部的 API 做统一的认证、授权，审计以及访问控制；
2. API 网关的实现重点在于**性能和扩展性**，你可以使用多路 I/O 复用模型和线程池并发处理，来提升网关性能，使用责任链模式来提升网关的扩展性；
3. API 网关中的线程池，可以针对不同的接口或者服务做隔离和保护，这样可以提升网关的可用性；
4. API 网关可以替代原本系统中的 Web 层，将 Web 层中的协议转换、认证、限流等功能挪入到 API 网关中，将服务聚合的逻辑下沉到服务层。

API 网关可以为 API 的调用提供便捷，也可以为将一些**服务治理的功能独立出来，达到复用的目的**，虽然在性能上可能会有一些损耗，但是一般来说，使用成熟的开源 API 网关组件，这些损耗都是可以接受的。所以，**当你的微服务系统越来越复杂时，你可以考虑使用  API 网关作为整体系统的门面**。
