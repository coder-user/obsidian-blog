商品的图片，介绍商品使用方法的视频等等静态资源，现在都放在了 Nginx 等 Web 服务器上，它们的**读请求量极大，并且对访问速度的要求很高，并且占据了很高的带宽，这时会出现访问速度慢，带宽被占满影响动态请求的问题**，那么你就需要考虑如何针对这些**静态资源进行读加速**了。

## 1 静态资源加速的考虑点

静态资源访问的关键点是**就近访问**。

单个视频和图片等**静态资源很大**，并且**访问量又极高**，如果使用业务服务器和分布式缓存来承担这些流量，无论是对于内网还是外网的带宽都会是很大的考验。

考虑在业务服务器的上层，增加一层特殊的缓存，用来承担绝大部分对于静态资源的访问，这一层特殊缓存的节点需要遍布在全国各地，这样可以让用户选择最近的节点访问。缓存的命中率也需要一定的保证，尽量减少访问资源存储源站的请求数量（回源请求），这层缓存即 `CDN`。

## 2 CDN 的关键技术

`CDN`（Content Delivery Network/Content Distribution Network，内容分发网络）

`CDN` 就是将静态的资源分发到，位于多个地理位置机房中的服务器上，因此它能很好地**解决数据就近访问的问题**，也就加快了静态资源的访问速度。

> [!question] 了解一下，要搭建一个 CDN 系统需要考虑哪两点？

### 2.1 如何将用户的请求映射到 CDN 节点上

将第三方厂商提供的 IP 隐藏起来，给到用户的最好是一个本公司域名的子域名（==依靠 DNS 来帮我们解决域名映射的问题==）

**DNS（Domain Name System，域名系统）** [DNS 中 A记录 和 CNAME](../../500-操作系统/DNS%20中%20A记录%20和%20CNAME.md) 实际上就是一个存储域名和 IP 地址对应关系的分布式数据库。

域名解析一般有两种：

1. **A 记录**：返回的是域名对应的 IP 地址
2. **CNAME 记录**：返回的是另一个域名，也就是说当前域名的解析要跳转到另一个域名的解析上

CDN 使用 **CNAME 记录**的方式。

> [!question] DNS 查询慢，如何解决这个性能问题？

1. 在 APP 启动时，对需要解析的域名做预先解析，然后把**解析的结果缓存**到本地的一个 LRU 缓存里面。
2. 为了避免 DNS 解析结果的变更造成缓存内数据失效，我们可以启动一个定时器，**定期地更新**缓存中的数据

将用户的请求映射到 CDN 服务器上，是使用 CDN 时需要解决的一个核心的问题，而 **CNAME 记录**在 DNS 解析过程中可以充当一个**中间代理层**的角色，可以把将用户最初使用的域名代理到正确的 IP 地址上。

### 2.2 如何找到离用户最近的 CDN 节点

`GSLB`（Global Server Load Balance，全局负载均衡）, 它的含义是对于部署在不同地域的服务器之间做负载均衡，下面可能管理了很多的本地负载均衡组件。

**主要有两方面的作用**：

1. 一种负载均衡服务器，负载均衡，顾名思义嘛，指的是让流量平均分配使得下面管理的服务器的负载更平均
2. 需要保证流量流经的服务器与流量源头在地缘上是比较接近的

GSLB 可以通过多种策略，来保证返回的 CDN 节点和用户尽量保证在同一地缘区域：

1. **地理位置**：可以将用户的 IP 地址按照地理位置划分为若干的区域，然后将 CDN 节点对应到一个区域上，然后根据用户所在区域来返回合适的节点。
2. **RTT**：通过发送数据包测量 RTT 的方式来决定返回哪一个节点。

**重点关注**：

1. 是否能够从 CDN 节点上获取到资源还取决于 CDN 的同步延时。
2. 使用 CDN 的时候需要关注 CDN 的命中率和源站的带宽情况。

## 3 小结

了解了 CDN 对静态资源进行加速的原理和使用的核心技术，这里你需要了解的重点有以下几点：

1. DNS 技术是 CDN 实现中使用的核心技术，可以将用户的请求映射到 CDN 节点上；
2. DNS 解析结果需要做本地缓存，降低 DNS 解析过程的响应时间；
3. GSLB 可以给用户返回一个离着他更近的节点，加快静态资源的访问速度。

`CDN` 是我们系统的门面，其缓存的静态数据，如图片和视频数据的请求量很可能是接口请求数据的几倍甚至更高，一旦发生故障，对于整体系统的影响是巨大的。

`CDN` 是我们整体系统至关重要的组成部分，而它作为一种特殊的缓存，其**命中率和可用性**也是我们服务端开发人员需要重点关注的指标。

**核心考虑**：

1. 如何将用户的请求映射到  CDN 节点
2. 如何找到离用户最近的 CDN 节点
