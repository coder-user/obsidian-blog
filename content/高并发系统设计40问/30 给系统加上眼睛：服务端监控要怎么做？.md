---
date: 2022-05-05T00:02:30.000Z
lastmod: 2022-05-08T22:34:56+08:00
tags:
  - 可见性
---

# 给系统加上眼睛：服务端监控要怎么做？

> [!question] 监控的作用和重要性是什么？

在一个项目的生命周期里，运行维护占据着很大的比重，在重要性上，它几乎与项目研发并驾齐驱。而在系统运维过程中，能够及时地发现问题并解决问题，是每一个团队的本职工作。

"道路千万条，监控第一条，监控不到位，领导两行泪"

## 监控指标如何选择

### 四个黄金信号

谷歌针对分布式系统监控的经验总结，**四个黄金信号（Four Golden Signals）**:
在**服务层面**一般需要监控四个指标：

- **延迟**：延迟指的是请求的响应时间
- **通信量**：通信量可以理解为吞吐量，也就是单位时间内，请求量的大小
- **错误**：错误表示当前系统发生的错误数量
- **饱和度**：饱和度指的是服务或者资源到达上限的程度（也可以说是服务或者资源的利用率）

### RED 指标体系

- R 代表请求量（Request rate）
- E 代表错误（Error）
- D 代表响应时间（Duration）

一些组件或者服务还有独特的指标，这些指标也是需要你特殊关注的：

- 数据库主从延迟数据
- 消息队列的堆积情况
- 缓存的命中率 [缓存](12丨缓存：数据库成为瓶颈后，动态数据的查询要如何加速？.md)

### 高并发系统中常见组件的监控指标

其中没有包含诸如 CPU、内存、网络、磁盘等基础监控指标，只是业务上监控指标，主要方便你在实际工作中参考使用。
![](高并发系统的业务监控指标.png)

## 如何采集数据指标

监控指标的采集，一般会依据采集数据源的不同，选用不同的采集方式，总结起来，大概有以下几种类型：

1. Agent 是一种比较常见的，采集数据指标的方式。
2. 另一种很重要的数据获取方式，是在代码中埋点。
3. 日志也是你监控数据的重要来源之一。（Filebeat）

**代码中埋点**：

这个方式与 Agent 的不同之处在于，Agent 主要收集的是组件服务端的信息，而埋点则是从客户端的角度，来描述所使用的组件，和服务的性能和可用性。

> [!question] 那么埋点的方式怎么选择呢？

在资源客户端中，直接计算调用资源或者服务的耗时、调用量、慢请求数，并且发送给监控服务器。(服务提供 metrics 的查询 Restful 接口查询，服务当前的状态)

## 监控数据的处理和存储

一般会部署两个队列处理程序，来消费消息队列中的数据：

1. 一个处理程序接收到数据后，把数据写入到 Elasticsearch，然后通过 Kibana 展示数据，这份数据主要是用来做原始数据的查询
2. 另一个处理程序是一些流式处理的中间件，比如，Spark、Storm。它们从消息队列里，接收数据后会做一些处理，这些处理包括：
   - 解析数据格式，尤其是日志格式
   - 对数据做一些聚合运算
   - 将数据存储在时间序列数据库中
   - 通过 Grafana 来连接时序数据库，将监控数据绘制成报表，呈现给开发和运维

## 监控系统常见的报表

1. **访问趋势报表**：这类报表接入的是 Web 服务器，和应用服务器的访问日志，展示了服务整体的访问量、响应时间情况、错误数量、带宽等信息。它主要反映的是，服务的整体运行情况，帮助你来发现问题
2. **性能报表**：这类报表对接的是资源和依赖服务的埋点数据，展示了被埋点资源的访问量和响应时间情况。它反映了资源的整体运行情况，当你从访问趋势报表发现问题后，可以先从性能报表中，找到究竟是哪一个资源或者服务出现了问题。
3. **资源报表**：这类报表主要对接的是，使用 Agent 采集的，资源的运行情况数据。当你从性能报表中，发现某一个资源出现了问题，那么就可以进一步从这个报表中，发现资源究竟出现了什么问题，是连接数异常增高，还是缓存命中率下降。这样可以进一步帮你分析问题的根源，找到解决问题的方案。

## 总结

**了解了，服务端监控搭建的过程**，在这里，你需要了解以下几个**重点**：

1. 耗时、请求量和错误数是三种最通用的监控指标，不同的组件还有一些特殊的监控指标，你在搭建自己的监控系统的时候可以直接使用；
2. Agent、埋点和日志是三种最常见的数据采集方式；
3. 访问趋势报表用来展示服务的整体运行情况，性能报表用来分析资源或者依赖的服务是否出现问题，资源报表用来追查资源问题的根本原因。这三个报表共同构成了你的服务端监控体系。

总之，监控系统是你发现问题，排查问题的重要工具，应该重视它，并且投入足够的精力来不断地完善它。只有这样，才能不断地提高对系统运维的掌控力，降低故障发生的风险。
