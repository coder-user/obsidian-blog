# 12 丨缓存：数据库成为瓶颈后，动态数据的查询要如何加速？

随着并发的增加，存储数据量的增多，数据库的磁盘 IO 逐渐成了系统的瓶颈，需要**一种访问更快的组件来降低请求响应时间**，提升整体系统性能。这时就会使用**缓存**。

> [!question] 那么什么是缓存，我们又该如何将它的优势最大化呢？

**缓存篇的总纲：**（三个方面全方位掌握缓存的设计思想和理念）

- 缓存定义
- 缓存分类
- 缓存优势劣势

## 1 什么是缓存

缓存，是一种**存储数据的组件**，它的作用是让对数据的请求更快地返回。

实际上，凡是位于速度相差较大的两种硬件之间，用于协调两者数据传输速度差异的结构，均可称之为缓存。

> [!question] 常见硬件组件的延时情况?

![](12丨缓存：数据库成为瓶颈后，动态数据的查询要如何加速？_image_1.png)
做一次内存寻址大概需要 **100ns**，而做一次磁盘的查找则需要 **10ms**。

**内存是最常见的一种缓存数据的介质。** 缓存作为一种常见的空间换时间的性能优化手段。

## 2 缓存案例

> [!note] Linux 内存管理缓存

Linux 内存管理是通过一个叫做 `MMU（Memory Management Unit）` 的硬件，来实现从虚拟地址到物理地址的转换的，但是如果每次转换都要做这么复杂计算的话，无疑会造成性能的损耗，所以会借助一个叫做 `TLB（Translation Lookaside Buffer）` 的组件来缓存最近转换过的虚拟地址，和物理地址的映射。

> [!note] HTTP 请求的缓存

![[12丨缓存：数据库成为瓶颈后，动态数据的查询要如何加速？_image_2.png]]

## 3 缓存与缓冲区

> [!question] 什么是缓冲区呢？缓冲和缓存只有一字之差，它们有什么区别呢？

**缓存**可以**提高低速设备的访问速度**，或者减少复杂耗时的计算带来的性能问题。
理论上说，我们可以通过缓存解决所有关于“慢”的问题，比如从磁盘随机读取数据慢，从数据库查询数据慢，只是不同的场景消耗的存储成本不同。

**缓冲区**则是一块临时存储数据的区域，这些数据后面会被传输到其他设备上。缓冲区更像“消息队列篇”中即将提到的消息队列，用以**弥补高速设备和低速设备通信时的速度差**。

## 4 缓存分类

> [!question] 常见的缓存？
>
> 1. 静态缓存
> 2. 分布式缓存
> 3. 热点本地缓存

### 4.1 静态缓存

只能针对静态数据来缓存。

### 4.2 分布式缓存

Memcached、Redis 就是分布式缓存的典型例子。

它们性能强劲，通过一些分布式的方案组成集群可以突破单机的限制。

### 4.3 热点本地缓存

对于静态的资源的缓存你可以选择静态缓存，对于动态的请求你可以选择分布式缓存。

> [!question] 那么什么时候要考虑热点本地缓存呢？
> 遇到极端的热点数据查询的时候。

本地缓存方案，如 `HashMap`，`Guava Cache` 或者是 `Ehcache` 等，它们和应用程序部署在同一个进程中，优势是不需要跨网络调度，速度极快，所以可以来阻挡短时间内的热点查询。

**使用示例**： [meeting-controller](../../../../200-Project/100-CloudV41/meeting-controller/meeting-controller.md) 使用的订阅全量数据返回的就是一个非常好的例子，使用本地热点数据本地缓存的方式，极大的提高了查询的性能，减少生成查询数据所需要内存的占用。

**本地缓存的特点：**

- 通常会等待缓存过期。
- 缓存时间短，通常为分钟或者秒级别。

由于本地缓存是部署在应用服务器中，而我们应用服务器通常会部署多台，当数据更新时，我们不能确定哪台服务器本地中了缓存，更新或者删除所有服务器的缓存不是一个好的选择，所以我们**通常会等待缓存过期**。因此，这种缓存的有效期很短，通常为分钟或者秒级别，以避免返回前端脏数据。

## 5 缓存的不足

缓存的主要作用是==提升访问速度==，从而能够抗住更高的并发。

事物都是具有两面性的，缓存也不例外，我们要了解它的优势的同时也需要了解它有哪些不足，从而**扬长避短，将它的作用发挥到最大**。

1. **缓存比较适合于读多写少的业务场景，并且数据最好带有一定的热点属性**。因为缓存毕竟会受限于存储介质不可能缓存所有数据，那么当数据有热点属性的时候才能保证一定的缓存命中率。
2. **缓存会给整体系统带来复杂度，并且会有数据不一致的风险**。当更新数据库成功，更新缓存失败的场景下，缓存中就会存在脏数据。对于这种场景，我们可以考虑使用**较短的过期时间**或者**手动清理**的方式来解决。
3. **缓存通常使用内存作为存储介质，但是内存并不是无限的**。因此，在使用缓存的时候要做数据存储量级的评估，对于**可预见的需要消耗极大存储成本的数据，要慎用缓存方案**。同时，缓存一定要设置过期时间，这样可以保证缓存中的会是热点数据。
4. **缓存会给运维也带来一定的成本**。

虽然有这么多的不足，但是缓存对于性能的提升是毋庸置疑的，我们在做架构设计的时候也需要把它考虑在内，只是在做具体方案的时候需要对缓存的设计有更细致的思考，才能最大化的发挥缓存的优势。

## 6 总结

强调的重点有以下几点：

1. **缓存可以有多层**，比如上面提到的静态缓存处在负载均衡层，分布式缓存处在应用层和数据库层之间，本地缓存处在应用层。我们需要将请求尽量挡在上层，因为越往下层，对于并发的承受能力越差；
2. **缓存命中率是我们对于缓存最重要的一个监控项** [metrics](30%20给系统加上眼睛：服务端监控要怎么做？.md)，越是热点的数据，缓存的命中率就越高。

缓存不仅仅是一种组件的名字，更是一种设计思想，你可以认为任何能够加速读请求的组件和设计方案都是缓存思想的体现。而这种加速通常是通过两种方式来实现：

- 使用更快的介质，比方说课程中提到的内存
- 缓存复杂运算的结果，比方说前面 TLB 的例子就是缓存地址转换的结果

那么，当你在实际**工作中碰到“慢”的问题时，缓存就是你第一时间需要考虑**的。
