一般来说，我们的核心缓存的命中率要保持在 99% 以上，非核心缓存的命中率也要尽量保证在 90%，如果低于这个标准，那么你可能就需要优化缓存的使用方式了。

面对缓存穿透时，有哪些应对措施。

## 1 什么是缓存穿透

**缓存穿透**其实是指从缓存中没有查到数据，而不得不从后端系统（比如数据库）中查询的情况。

**少量的缓存穿透不可避免**，对系统也是没有损害的，主要有几点原因：

1. 互联网系统通常会面临极大数据量的考验，而**缓存系统在容量上是有限**的，不可能存储系统所有的数据，那么在查询未缓存数据的时候就会发生缓存穿透。
2. 互联网系统的数据访问模型一般会遵从**80/20 原则**。**80/20 原则**又称为帕累托法则，是意大利经济学家帕累托提出的一个经济学的理论。它是指在一组事物中，最重要的事物通常只占 20%，而剩余的 80% 的事物确实不重要的。把它应用到数据访问的领域，就是我们会经常访问 20% 的热点数据，而另外的 80% 的数据则不会被经常访问。比如你买了很多衣服，很多书，但是其实经常穿的，经常看的，可能也就是其中很小的一部分。

既然缓存的容量有限，并且大部分的访问只会请求 20% 的热点数据，那么理论上说，我们只需要在有限的缓存空间里存储 20% 的热点数据就可以有效地保护脆弱的后端系统了，也就可以放弃缓存另外 80% 的非热点数据了。所以，这种少量的缓存穿透是不可避免的，但是对系统是没有损害的。

> [!question] 什么样的缓存穿透对系统有害呢？

大量的穿透请求超过了后端系统的承受范围，造成了后端系统的崩溃。

## 2 缓存穿透的解决方案

> [!example] 场景一：查询未存在的数据？

两种解决方案：

1. **回种空值**
2. **使用布隆过滤器**

### 2.1 回种空值

空值加一个比较短的过期时间，让空值在短时间之内能够快速过期淘汰。这个方案，在使用的时候应该评估一下缓存容量是否能够支撑。

### 2.2 使用布隆过滤器

> [!question] 那么我们如何使用布隆过滤器来解决缓存穿透的问题呢？

以存储用户信息的表为例。

1. 初始化一个很大的数组，比方说长度为 20 亿的数组
2. 选择一个 Hash 算法，然后我们将目前现有的所有用户的 ID 计算出 Hash 值并且映射到这个大数组中，映射位置的值设置为 1，其它值设置为 0

![[15丨缓存的使用姿势（三）：缓存穿透了怎么办？_image_1.png]]

- 布隆过滤器拥有极高的性能，无论是写入操作还是读取操作，时间复杂度都是 O (1)，是常量值。
- 在空间上，相对于其他数据结构它也有很大的优势。

> [!bug] 主要有两个缺陷：

1. 在判断元素是否在集合中时是有一定错误几率的，比如它会把不是集合中的元素判断为处在集合中（Hash 算法的问题：碰撞）
2. 不支持删除元素（布隆过滤器不支持删除元素的缺陷也和 Hash 碰撞有关）

**布隆过滤器特点**：当布隆过滤器判断元素在集合中时，这个元素可能不在集合中。但是一旦布隆过滤器判断这个元素不在集合中时，它一定不在集合中。**非常适合解决缓存穿透的问题**

> [!tip] 关于布隆过滤器的使用上，几个建议：

1. 选择多个 Hash 函数计算多个 Hash 值，这样可以减少误判的几率；
2. 布隆过滤器会消耗一定的内存空间，所以在使用时需要评估你的业务场景下需要多大的内存，存储的成本是否可以接受。

回种空值和布隆过滤器是解决缓存穿透问题的两种最主要的解决方案，但是它们也有各自的适用场景，并不能解决所有问题。

比方说当有一个极热点的缓存项，它一旦失效会有大量请求穿透到数据库，这会对数据库造成瞬时极大的压力，我们把这个场景叫做“dog-pile effect”（狗桩效应），这是典型的缓存并发穿透的问题，那么，我们如何来解决这个问题呢？  解决狗桩效应的思路是尽量地减少缓存穿透后的并发，方案也比较简单：

1. 在代码中，控制在某一个热点缓存项失效之后启动一个后台线程，穿透到数据库，将数据加载到缓存中，在缓存未加载之前，所有访问这个缓存的请求都不再穿透而直接返回。
2. 通过在 Memcached 或者 Redis 中设置分布式锁，只有获取到锁的请求才能够穿透到数据库。

## 3 总结

了解了解决缓存穿透的方案，在发现自己的缓存系统命中率下降时，从中得到一些借鉴的思路。

1. **回种空值**是一种最常见的解决思路，实现起来也最简单，如果评估空值缓存占据的缓存空间可以接受，那么可以优先使用这种方案；
2. **布隆过滤器**会引入一个新的组件，也会引入一些开发上的复杂度和运维上的成本。所以只有在存在海量查询数据库中，不存在数据的请求时才会使用，在使用时也要关注布隆过滤器对内存空间的消耗；
3. 对于极热点缓存数据穿透造成的“狗桩效应”，可以通过设置**分布式锁或者后台线程定时加载的方式来解决**。

除此之外，你还需要了解的是，**数据库是一个脆弱的资源，它无论是在扩展性、性能还是承担并发的能力上，相比缓存都处于绝对的劣势**，所以我们解决缓存穿透问题的**核心目标在于减少对于数据库的并发请求**。了解了这个核心的思想，也许你还会在日常工作中找到其他更好的解决缓存穿透问题的方案。
