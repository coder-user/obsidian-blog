> [!question] 系统设计的目的是什么？
>
> - 为了获得更好的性能
> - 更高的可用性
> - 更强的系统扩展能力

> [!tip] 作者写作的思路是什么？
>
> 1. 当这个系统到达某一个阶段时，我们会遇到什么问题，然后要采用什么样的方案应对，应对的过程中又涉及哪些技术点，力求以案例引出问题。
> 2. 能够让你了解遇到不同问题时，解决思路是怎样的。
> 3. 在这个过程中，我希望你能多加思考，然后将学到的知识活学活用到实际的项目中。

> [!important] 示例：面向某个垂直领域的电商系统

## 1 用连接池预先建立数据库连接

**常见的连接池使用场景**：

- 数据库连接池
- HTTP 连接池
- Redis 连接池

**连接池的管理是连接池设计的核心**（两个最重要的配置）：

- 最小连接数（空闲连接数\最大空闲连接数）
- 最大连接数

其次，**空闲连接时间**也是一个比较重要的指标。先根据经验配置，后续根据实际性能测试进行调优。

> [!summary]
> 对于数据库连接池，根据经验，一般在线上我建议最小连接数控制在 10 左右，最大连接数控制在 20～30 左右即可

**连接池中获取连接的流程**：

1. 如果当前连接数小于最小连接数，则创建新的连接处理数据库请求；
2. 如果连接池中有空闲连接则复用空闲连接；
3. 如果空闲池中没有连接并且当前连接数小于最大连接数，则创建新的连接处理请求；
4. 如果当前连接数已经大于等于最大连接数，则按照配置中设定的时间（C3P0 的连接池配置是 checkoutTimeout）等待旧的连接可用；
5. 如果等待超过了这个设定时间则向用户抛出错误。

> [!question] 连接池维护的问题?\
> **非常重要的问题：客户端空闲连接超时时间和服务端空闲超时时间的匹配**
>
> 1. 数据库的域名对应的 IP 发生了变更，池子的连接还是使用旧的 IP，当旧的 IP 下的数据库服务关闭后，再使用这个连接查询就会发生错误；
> 2. MySQL 有个参数是“wait_timeout”，控制着当数据库连接闲置多长时间后，数据库会主动的关闭这条连接。这个机制对于数据库使用方是无感知的，所以当我们使用这个被关闭的连接时就会发生错误。

> [!question] 如何保证连接池的连接都是可用的状态？
>
> 1. 启动一个线程来定期检测连接池中的连接是否可用（推荐）
> 2. 在获取到连接之后，先校验连接是否可用。这种方式在获取连接时会引入多余的开销

实际上，大多数的连接池并没有对此进行处理。

## 2 池化技术

一种常见的软件设计思想，叫做池化技术。它的核心思想是**空间换时间**，期望使用预先创建好的对象来**减少频繁创建对象的性能开销**，同时还可以对对象进行统一的管理，降低了对象的使用的成本，以达到提升性能和资源复用的目的。

常见的有：

- 连接池
- 内存池
- 线程池
- 进程池

**缺点**：

- 比方说存储池子中的对象肯定需要消耗多余的内存，如果对象没有被频繁使用，就会造成**内存上的浪费**
- 池子中的对象需要在系统启动的时候就预先创建完成，这在一定程度上**增加了系统启动时间**

> [!question] 什么时候考虑使用连接池？

可这些缺陷相比池化技术的优势来说就比较微不足道了，只要确认要使用的对象在**创建时确实比较耗时或者消耗资源**，并且这些对象也确实会被**频繁地创建和销毁**，就可以使用池术来优化。

池化技术核心是一种空间换时间优化方法的实践，所以要**关注空间占用情况**，避免出现空间过度使用出现内存泄露或者频繁垃圾回收等问题。

## 3 其他考虑

- 添加连接数的 metrics 统计，便于观察数据。
