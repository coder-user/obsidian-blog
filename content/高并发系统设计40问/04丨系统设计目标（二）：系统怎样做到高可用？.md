**高可用性**（High Availability，HA）：指的是系统具备较高的无故障运行的能力。

一个高并发大流量的系统，系统出现故障比系统性能低更损伤用户的使用体验。

## 1 可用性的度量

可用性是一个抽象的概念，MTBF 和 MTTR：

- **MTBF**（Mean Time Between Failure）是平均故障间隔的意思，代表两次故障的间隔时间，也就是系统正常运转的平均时间。这个时间越长，系统稳定性越高。
- **MTTR**（Mean Time To Repair）表示故障的平均恢复时间，也可以理解为平均故障时间。这个值越小，故障对于用户的影响越小。

**公式表示它们之间的关系**：`Availability = MTBF / (MTBF + MTTR)` 公式计算出的结果是一个比例，而这个比例代表着系统的可用性。

通常使用**几个九**来描述系统的可用性，通常核心业务系统的可用性，需要达到四个九，非核心系统的可用性最多容忍到三个九。

**四个九之后**：建立完善的运维值班系统、故障处理流程和业务变更流程，系统设计上：发生故障，是否不用人工接入就能自动恢复。工具建设方面：多加完善，以便快速排查故障原因，让系统快速恢复。
**五个九之后**：考察的是系统的容灾和自动恢复的能力，让机器来处理故障，才会让可用性指标提升一个档次


## 2 高可用系统设计的思路

一个成熟系统的可用性需要从**系统设计**和**系统运维**两方面来做保障，两者**共同作用，缺一不
可。**

> [!question]  如何从这两方面入手，解决系统高可用的问题呢？

### 2.1 系统设计

**Design for failure**是做高可用系统设计时秉持的第一原则。

还需要掌握一些**具体的优化方法**，比如：

- failover（故障转移）
- 超时控制
- 降级
- 限流

#### 2.1.1 故障转义

一般来说，发生 failover 的节点可能有两种情况：

1. 是在**完全对等的节点**之间做 failover：不保存状态，故障随机切换其他可用节点。
2. 是在**不对等的节点**之间，即系统中存在主节点也存在备节点：比方说我们有一个主节点，有多台备用节点，这些备用节点可以是热备（同样在线提供服务的备用节点），也可以是冷备（只作为备份使用），那么我们就需要在代码中控制如何检测主备机器是否故障，以及如何做主备切换。

使用最广泛的故障检测机制是**心跳**，触发选主的操作。选主的结果需要在多个备份节点上达成一致，所以会使用**某一种分布式一致性算法**，比方说 Paxos，Raft。

#### 2.1.2 超时控制

对于系统间调用超时的控制也是高可用系统设计的一个重要考虑方面。

**调用最怕的就是延迟而非失败，因为失败通常是瞬时的，可以通过重试的方式解决**。而一旦调用某一个模块或者服务发生比较大的延迟，调用方就会阻塞在这次调用上，它已经占用的资源得不到释放。当存在大量这种阻塞请求时，调用方就会因为用尽资源而挂掉。

> [!question] 既然要做超时控制，那么我们怎么来确定超时时间呢？

超时时间短了，会造成大量的超时错误，对用户体验产生影响；超时时间长了，又起不到作用。

建议通过**收集系统之间的调用日志**，统计比如说 **99% 的响应时间**是怎样的，然后依据这个时间来指定超时时间。

无论你使用哪种方式，超时时间都不是一成不变的，需要在后面的系统维护过程中不断地修改。

超时控制实际上就是不让请求一直保持，而是在经过一定时间之后让请求失败，释放资源给接下来的请求使用。这**对于用户来说是有损的**，但是却是必要的，因为它牺牲了少量的请求却保证了整体系统的可用性。

另外两种**有损的方案**能保证系统的高可用：

1. 降级
2. 限流

#### 2.1.3 降级

降级是为了保证核心服务的稳定而牺牲非核心服务的做法。

#### 2.1.4 限流

限流完全是另外一种思路，它通过对并发的请求进行限速来保护系统。

这种做法损害了用户的使用体验，但是它是在**极端并发下的无奈之举，是短暂的行为**，因此是可以接受的。

### 2.2 系统运维

> [!question] 系统运维的层面能做哪些事情呢？
>
> 1. 灰度发布
> 2. 故障演练

#### 2.2.1 灰度发布

在业务平稳运行过程中，系统是很少发生故障的，90% 的故障是发生在上线变更阶段的。

灰度发布指的是系统的变更不是一次性地推到线上的，而是按照一定比例逐步推进的。

灰度发布给了开发和运维同学绝佳的机会，让他们能在线上流量上观察变更带来的影响，是保证系统高可用的重要关卡。

#### 2.2.2 故障演练

灰度发布是在系统正常运行条件下，保证系统高可用的运维手段，那么我们如何知道发生故障时系统的表现呢？

- 故障演练

**故障演练**：指的是对系统进行一些破坏性的手段，观察在出现局部故障时，整体的系统表现是怎样的，从而发现系统中存在的，潜在的可用性问题。

故障演练和时下比较流行的**混沌工程**的思路如出一辙，作为混沌工程的鼻祖，Netfix 在 2010 年推出的 `Chaos Monkey` 工具就是故障演练绝佳的工具。

## 3 总结

**开发**：注重的是如何处理故障，关键词是冗余和取舍。冗余指的是有备用节点，集群来顶替出故障的服务，比如文中提到的故障转移，还有多活架构等等；取舍指的是丢卒保车，保障主体服务的安全。
**运维**：角度来看则更偏保守，注重的是如何避免故障的发生，比如更关注变更管理以及如何做故障的演练。

两者结合起来才能组成一套完善的高可用体系。
